<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Triple A - System Monitor</title>

    <!-- Refresh auto toutes les 30s -->
    <meta http-equiv="refresh" content="30">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='template.css') }}">

    <!-- Police Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">

    <!-- Icônes -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>
<body>

<header>
    <h1><i class="fas fa-bolt"></i> Triple A - System Monitor</h1>
    <p>Généré le : <span id="timestamp">{{ generated_at }}</span></p>
</header>

<main>

    <!-- SYSTÈME -->
    <section>
        <h2><i class="fas fa-server"></i> Système</h2>
        <p>Nom de la machine : <strong>{{ machine_name }}</strong></p>
        <p>Système d'exploitation : <strong>{{ system_name }}</strong></p>
        <p>Heure de démarrage : <strong>{{ boot_time }}</strong></p>
        <p>Temps de fonctionnement : <strong>{{ uptime }}</strong></p>
        <p>Utilisateurs connectés : <strong>{{ users_count }}</strong></p>

        <hr>
        <h3>Load average</h3>
        <p class="small">1 min : <strong>{{ load1 }}</strong> | 5 min : <strong>{{ load5 }}</strong> | 15 min : <strong>{{ load15 }}</strong></p>
    </section>

    <!-- CPU -->
    <section>
        <h2><i class="fas fa-microchip"></i> CPU</h2>
        <p>Nombre de cœurs (logiques) : <strong>{{ cpu_cores }}</strong></p>

        <!-- CPU global -->
        <div class="gauge">
            <div class="label">CPU total</div>
            <div class="value">
                <div class="bar-container"><div id="cpu-global-bar" class="bar"></div></div>
                <div class="small" id="cpu-global-label">{{ cpu_usage }} %</div>
            </div>
        </div>

        <hr>

        <!-- CPU par cœur -->
        <h3>Par cœur</h3>
        <div>
            {% for val in per_core %}
            <div class="gauge">
                <div class="label">Cœur {{ loop.index0 }}</div>
                <div class="value">
                    <div class="bar-container">
                        <div class="bar per-core-bar" data-val="{{ val }}" id="core-bar-{{ loop.index0 }}"></div>
                    </div>
                    <div class="small" id="core-label-{{ loop.index0 }}">{{ val }} %</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>

    <!-- RAM & DISQUE -->
    <section>
        <h2><i class="fas fa-memory"></i> Mémoire & Disque</h2>

        <div class="gauge">
            <div class="label">RAM</div>
            <div class="value">
                <div class="bar-container"><div id="ram-bar" class="bar"></div></div>
                <div class="small">{{ ram_used }} / {{ ram_total }} GB ({{ ram_percent }}%)</div>
            </div>
        </div>

        <div class="gauge">
            <div class="label">Disque ( / )</div>
            <div class="value">
                <div class="bar-container"><div id="disk-bar" class="bar"></div></div>
                <div class="small">{{ disk_used }} / {{ disk_total }} GB ({{ disk_percent }}%)</div>
            </div>
        </div>

        <hr>
        <h3>Top 3 processus</h3>
        <ul>
            <li>{{ process1 }}</li>
            <li>{{ process2 }}</li>
            <li>{{ process3 }}</li>
        </ul>
    </section>

    <!-- ANALYSE FICHIERS -->
    <section style="grid-column: 1 / -1;">
        <h2><i class="fas fa-folder-open"></i> Analyse de fichiers approfondie</h2>
        <p class="small">Fichiers analysés : <strong>{{ total_files }}</strong> | Espace total : <strong>{{ total_size_hr }}</strong></p>

        <h3>Par type d'extension</h3>
        <table>
            <thead>
                <tr><th>Extension</th><th>Nombre</th><th>% (nombres)</th><th>Occupation</th><th>% (taille)</th></tr>
            </thead>
            <tbody>
                {% for row in ext_rows %}
                <tr>
                    <td><strong>{{ row.ext }}</strong></td>
                    <td>{{ row.count }}</td>
                    <td>{{ row.count_percent }}%</td>
                    <td>{{ row.size_hr }}</td>
                    <td>{{ row.size_percent }}%</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <h3 style="margin-top:12px;">Fichiers les plus volumineux</h3>
        <div class="top-files">
            <table>
                <thead><tr><th>Fichier</th><th>Taille</th></tr></thead>
                <tbody>
                    {% for f in top_files %}
                    <tr><td title="{{ f.path }}">{{ f.path|truncate(80) }}</td><td>{{ f.size_hr }}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>

</main>

<footer>
    <p>Challenge Triple A - Dashboard Monitoring</p>
</footer>

<script>
    function getColorClass(pct) {
        if (pct <= 50) return "c-vert";
        if (pct <= 80) return "c-orange";
        return "c-rouge";
    }

    // CPU global
    (function(){
        const val = parseFloat("{{ cpu_usage }}");
        const el = document.getElementById("cpu-global-bar");
        el.style.width = val + "%";
        el.className = "bar " + getColorClass(val);
    })();

    // RAM
    (function(){
        const val = parseFloat("{{ ram_percent }}");
        const el = document.getElementById("ram-bar");
        el.style.width = val + "%";
        el.className = "bar " + getColorClass(val);
    })();

    // Disque
    (function(){
        const val = parseFloat("{{ disk_percent }}");
        const el = document.getElementById("disk-bar");
        el.style.width = val + "%";
        el.className = "bar " + getColorClass(val);
    })();

    // CPU par cœur
    (function(){
        const cores = {{ per_core | tojson }};
        for(let i=0;i<cores.length;i++){
            const val = parseFloat(cores[i]) || 0;
            const bar = document.getElementById("core-bar-" + i);
            if(bar) {
                bar.style.width = val + "%";
                bar.className = "bar per-core-bar " + getColorClass(val);
            }
        }
    })();
</script>

</body>
</html>
